<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Where Am I Listening?</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="icon" type="image/x-icon" href="img/favicon.ico">
    <!-- Globe.gl -->
    <script src="https://unpkg.com/globe.gl"></script>
</head>
<body class="globe-page">
    <h1 class="title fade">Where Am I Listening?</h1>

    <!-- Loading overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
        <p id="loading-status">Loading your top artists...</p>
        <div id="progress-bar" class="progress-bar">
            <div id="progress-fill" class="progress-fill"></div>
        </div>
        <p id="loading-detail" class="loading-detail"></p>
    </div>

    <!-- Globe container -->
    <div id="globe-container"></div>

    <!-- Controls -->
    <div class="controls fade">
        <button id="theme-toggle" class="control-btn" title="Toggle theme">
            <span id="theme-icon">ðŸŒ™</span>
        </button>
        <button id="logout-btn" class="control-btn" title="Logout">
            <span>ðŸšª</span>
        </button>
    </div>

    <!-- Artist list sidebar -->
    <div id="artist-sidebar" class="sidebar fade">
        <h3>Your Top Artists</h3>
        <div id="artist-list"></div>
    </div>

    <!-- Stats -->
    <div id="stats" class="stats fade" style="display: none;">
        <p><span id="artist-count">0</span> artists from <span id="country-count">0</span> countries</p>
    </div>

    <!-- Artist modal -->
    <div id="artist-modal" class="artist-modal" style="display: none;">
        <div class="artist-modal-content">
            <button class="modal-close" onclick="closeArtistModal()">&times;</button>
            <div id="modal-artists"></div>
        </div>
    </div>

    <script type="module" src="js/auth.js"></script>
    <script type="module" src="js/spotify.js"></script>
    <script type="module" src="js/api.js"></script>
    <script type="module" src="js/globe.js"></script>
    <script type="module">
        let isDarkTheme = true;
        let allArtists = [];

        async function init() {
            // Check if logged in
            if (!window.SpotifyAuth.isLoggedIn()) {
                window.location.href = 'index.html';
                return;
            }

            try {
                updateStatus('Fetching your top artists from Spotify...');

                // Get access token
                const token = await window.SpotifyAuth.getValidToken();

                // Fetch top artists
                const rawArtists = await window.SpotifyAPI.fetchTopArtists(token, 50);
                const artists = window.SpotifyAPI.extractArtistData(rawArtists);

                updateStatus(`Found ${artists.length} artists. Fetching locations...`);

                // Fetch locations - try worker first, fallback to direct
                let artistsWithLocations;
                try {
                    artistsWithLocations = await window.LocationAPI.fetchArtistLocations(
                        artists,
                        handleProgress
                    );
                } catch (e) {
                    console.warn('Worker failed, using direct fetch:', e);
                    updateStatus('Using direct lookup (this may take a while)...');
                    artistsWithLocations = await window.LocationAPI.fetchLocationsDirectly(
                        artists,
                        handleProgress
                    );
                }

                allArtists = artistsWithLocations;

                // Initialize globe
                const container = document.getElementById('globe-container');
                window.GlobeViz.initGlobe(container, artistsWithLocations);

                // Populate sidebar
                populateSidebar(artistsWithLocations);

                // Update stats
                updateStats(artistsWithLocations);

                // Hide loading overlay
                hideLoading();

                // Fade UI elements when hovering over the globe vs UI
                const fadeElements = document.querySelectorAll('.fade');

                // Fade out UI when mouse enters globe area
                container.addEventListener('mouseenter', () => {
                    fadeElements.forEach(el => el.classList.add('faded'));
                });

                // Show UI when mouse enters any UI element
                fadeElements.forEach(el => {
                    el.addEventListener('mouseenter', () => {
                        fadeElements.forEach(f => f.classList.remove('faded'));
                    });
                });

            } catch (error) {
                console.error('Initialization error:', error);
                updateStatus(`Error: ${error.message}`);

                if (error.message.includes('401') || error.message.includes('token')) {
                    window.SpotifyAuth.logout();
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                }
            }
        }

        function updateStatus(message) {
            document.getElementById('loading-status').textContent = message;
        }

        function handleProgress(progress) {
            const progressFill = document.getElementById('progress-fill');
            const loadingDetail = document.getElementById('loading-detail');

            if (progress.type === 'cache') {
                updateStatus(`Found ${progress.cached} cached, fetching ${progress.remaining} more...`);
                progressFill.style.width = `${(progress.cached / (progress.cached + progress.remaining)) * 100}%`;
            } else if (progress.type === 'worker-mode') {
                loadingDetail.textContent = 'Using location worker for fast parallel lookups.';
            } else if (progress.type === 'progress') {
                updateStatus(`Looking up: ${progress.artist} (${progress.current}/${progress.total})`);
                progressFill.style.width = `${(progress.current / progress.total) * 100}%`;
            } else if (progress.type === 'direct-mode') {
                loadingDetail.textContent = 'Using direct MusicBrainz lookup (1 request/sec rate limit). Results are cached for faster future loads.';
            } else if (progress.type === 'complete') {
                updateStatus('All locations loaded!');
                progressFill.style.width = '100%';
                loadingDetail.textContent = '';
            } else if (progress.type === 'error') {
                console.warn('Progress error:', progress.error);
            }
        }

        function hideLoading() {
            const overlay = document.getElementById('loading-overlay');
            overlay.classList.add('fade-out');
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 500);
        }

        function populateSidebar(artists) {
            const list = document.getElementById('artist-list');
            list.innerHTML = '';

            // Sort: known locations first, then unknown at the end
            const knownArtists = artists.filter(a => a.location_name && a.location_name !== 'Unknown');
            const unknownArtists = artists.filter(a => !a.location_name || a.location_name === 'Unknown');
            const sortedArtists = [...knownArtists, ...unknownArtists];

            sortedArtists.forEach(artist => {
                const isUnknown = !artist.location_name || artist.location_name === 'Unknown';
                const item = document.createElement('div');
                item.className = 'artist-item' + (isUnknown ? ' unknown' : '');
                item.innerHTML = `
                    ${artist.image ? `<img src="${artist.image}" alt="${artist.name}">` : '<div class="no-image"></div>'}
                    <div class="artist-info">
                        <span class="artist-name">${artist.name}</span>
                        <span class="artist-location">${artist.location_name || 'Unknown'}</span>
                    </div>
                `;
                if (!isUnknown) {
                    item.addEventListener('click', () => {
                        window.GlobeViz.flyToArtist(artist);
                    });
                }
                list.appendChild(item);
            });

            // Add MusicBrainz contribution notice
            const notice = document.createElement('div');
            notice.className = 'musicbrainz-notice';
            notice.innerHTML = `
                <p>See something wrong?</p>
                <a href="https://musicbrainz.org/doc/How_to_Add_an_Artist" target="_blank" rel="noopener">
                    Contribute to MusicBrainz
                </a>
            `;
            list.appendChild(notice);
        }

        function updateStats(artists) {
            const validArtists = artists.filter(a => a.location_coord);
            const countries = new Set(
                artists
                    .filter(a => a.location_name && a.location_name !== 'Unknown')
                    .map(a => {
                        const parts = a.location_name.split(',');
                        return parts[parts.length - 1].trim();
                    })
            );

            document.getElementById('artist-count').textContent = validArtists.length;
            document.getElementById('country-count').textContent = countries.size;
            document.getElementById('stats').style.display = 'block';
        }

        // Artist modal functions
        function openArtistModal(artists) {
            const container = document.getElementById('modal-artists');
            container.innerHTML = artists.map(a => `
                <a href="${a.spotifyUrl || '#'}" target="_blank" rel="noopener" class="modal-artist${a.spotifyUrl ? '' : ' no-link'}">
                    ${a.image ? `<img src="${a.image}" alt="${a.name}">` : '<div class="no-image"></div>'}
                    <div class="modal-artist-info">
                        <span class="modal-artist-name">${a.name}</span>
                        <span class="modal-artist-location">${a.location_name || 'Unknown'}</span>
                    </div>
                    <svg class="spotify-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/></svg>
                </a>
            `).join('');
            document.getElementById('artist-modal').style.display = 'flex';
        }

        function closeArtistModal() {
            document.getElementById('artist-modal').style.display = 'none';
        }

        // Close modal on backdrop click
        document.getElementById('artist-modal').addEventListener('click', (e) => {
            if (e.target.id === 'artist-modal') {
                closeArtistModal();
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeArtistModal();
            }
        });

        // Expose for globe.js
        window.openArtistModal = openArtistModal;
        window.closeArtistModal = closeArtistModal;

        // Theme toggle
        document.getElementById('theme-toggle').addEventListener('click', (e) => {
            e.stopPropagation();
            isDarkTheme = !isDarkTheme;
            window.GlobeViz.setGlobeTheme(isDarkTheme ? 'dark' : 'light');
            document.getElementById('theme-icon').textContent = isDarkTheme ? 'ðŸŒ™' : 'â˜€ï¸';
        });

        // Logout
        document.getElementById('logout-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            window.SpotifyAuth.logout();
            window.location.href = 'index.html';
        });

        // Initialize on load
        init();
    </script>
</body>
</html>
